{% extends "base-eco.html" %}

{% block content %}
<!-- Pickup Status Tracking Page -->
<style>
    .status-header {
        background: linear-gradient(135deg, #2E7D32, #4CAF50);
        border-radius: var(--radius-xl);
        padding: 2rem;
        color: white;
        margin-bottom: 2rem;
    }

    .status-header h1 {
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .request-id-display {
        background: rgba(255, 255, 255, 0.2);
        padding: 0.5rem 1rem;
        border-radius: var(--radius-full);
        display: inline-block;
        font-family: monospace;
        font-size: 1.1rem;
    }

    .status-timeline {
        position: relative;
        padding-left: 3rem;
    }

    .status-timeline::before {
        content: '';
        position: absolute;
        left: 1rem;
        top: 0;
        bottom: 0;
        width: 3px;
        background: var(--eco-light-green);
    }

    .timeline-item {
        position: relative;
        margin-bottom: 2rem;
        padding-left: 1rem;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -2.6rem;
        top: 0.3rem;
        width: 1.2rem;
        height: 1.2rem;
        border-radius: 50%;
        background: white;
        border: 3px solid var(--eco-light-green);
    }

    .timeline-item.active::before {
        background: var(--eco-primary);
        border-color: var(--eco-primary);
    }

    .timeline-item.completed::before {
        background: #4CAF50;
        border-color: #4CAF50;
    }

    .timeline-label {
        font-weight: 600;
        color: var(--eco-dark);
        margin-bottom: 0.25rem;
    }

    .timeline-time {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .detail-card {
        background: white;
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .detail-card h3 {
        color: var(--eco-dark);
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid #eee;
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .detail-label {
        color: var(--text-secondary);
        font-weight: 500;
    }

    .detail-value {
        color: var(--text-primary);
        font-weight: 600;
        text-align: right;
    }

    .partner-card {
        background: linear-gradient(135deg, rgba(46, 125, 50, 0.05), rgba(76, 175, 80, 0.05));
        border: 2px solid var(--eco-light-green);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .rating-stars {
        color: #FFC107;
        font-size: 1.5rem;
    }

    @media (max-width: 768px) {
        .status-timeline {
            padding-left: 2.5rem;
        }

        .timeline-item::before {
            left: -2.1rem;
        }
    }
</style>

<div class="container">
    <!-- Header -->
    <div class="status-header">
        <h1><i class="fas fa-truck-pickup"></i> Pickup Status</h1>
        <div class="request-id-display">{{ pickup.request_id }}</div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Status Timeline -->
            <div class="detail-card">
                <h3><i class="fas fa-history"></i> Status Timeline</h3>
                <div class="status-timeline">
                    <div class="timeline-item {% if pickup.status in ['Requested', 'Assigned', 'Scheduled', 'Picked', 'Completed'] %}completed{% endif %}">
                        <div class="timeline-label">Request Submitted</div>
                        <div class="timeline-time">{{ pickup.created_at.strftime('%b %d, %Y at %I:%M %p') }}</div>
                    </div>

                    <div class="timeline-item {% if pickup.status in ['Assigned', 'Scheduled', 'Picked', 'Completed'] %}completed{% elif pickup.status == 'Requested' %}active{% endif %}">
                        <div class="timeline-label">Partner Assigned</div>
                        {% if pickup.assigned_partner %}
                            <div class="timeline-time">{{ pickup.assigned_partner.name }}</div>
                        {% else %}
                            <div class="timeline-time">Waiting for assignment...</div>
                        {% endif %}
                    </div>

                    <div class="timeline-item {% if pickup.status in ['Scheduled', 'Picked', 'Completed'] %}completed{% elif pickup.status == 'Assigned' %}active{% endif %}">
                        <div class="timeline-label">Pickup Scheduled</div>
                        {% if pickup.scheduled_time_slot %}
                            <div class="timeline-time">{{ pickup.scheduled_time_slot }}</div>
                        {% else %}
                            <div class="timeline-time">Not scheduled yet</div>
                        {% endif %}
                    </div>

                    <div class="timeline-item {% if pickup.status in ['Picked', 'Completed'] %}completed{% elif pickup.status == 'Scheduled' %}active{% endif %}">
                        <div class="timeline-label">Waste Collected</div>
                        <div class="timeline-time">
                            {% if pickup.status in ['Picked', 'Completed'] %}
                                Pickup in progress
                            {% else %}
                                Awaiting pickup
                            {% endif %}
                        </div>
                    </div>

                    <div class="timeline-item {% if pickup.status == 'Completed' %}completed{% elif pickup.status == 'Picked' %}active{% endif %}">
                        <div class="timeline-label">Completed</div>
                        {% if pickup.status == 'Completed' %}
                            <div class="timeline-time">
                                {% if pickup.completed_date %}
                                    {{ pickup.completed_date.strftime('%b %d, %Y at %I:%M %p') }}
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="timeline-time">Pending completion</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Pickup Details -->
            <div class="detail-card">
                <h3><i class="fas fa-info-circle"></i> Pickup Details</h3>
                <div class="detail-row">
                    <span class="detail-label">Waste Type</span>
                    <span class="detail-value">{{ pickup.waste_type }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Estimated Quantity</span>
                    <span class="detail-value">{{ pickup.estimated_quantity }} {{ pickup.quantity_unit }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Pickup Address</span>
                    <span class="detail-value">{{ pickup.pickup_address }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Area</span>
                    <span class="detail-value">{{ pickup.area or 'N/A' }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Preferred Date</span>
                    <span class="detail-value">{{ pickup.preferred_date.strftime('%b %d, %Y') }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Preferred Time</span>
                    <span class="detail-value">{{ pickup.preferred_time_slot }}</span>
                </div>
                {% if pickup.description %}
                <div class="detail-row">
                    <span class="detail-label">Notes</span>
                    <span class="detail-value">{{ pickup.description }}</span>
                </div>
                {% endif %}
            </div>

            {% if pickup.status == 'Completed' and pickup.collected_weight_kg %}
            <div class="detail-card">
                <h3><i class="fas fa-check-circle text-success"></i> Collection Summary</h3>
                <div class="detail-row">
                    <span class="detail-label">Collected Weight</span>
                    <span class="detail-value">{{ pickup.collected_weight_kg }} kg</span>
                </div>
                {% if pickup.partner_notes %}
                <div class="detail-row">
                    <span class="detail-label">Partner Notes</span>
                    <span class="detail-value">{{ pickup.partner_notes }}</span>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <div class="col-lg-4">
            <!-- Assigned Partner -->
            {% if pickup.assigned_partner %}
            <div class="partner-card">
                <h3><i class="fas fa-user"></i> Assigned Partner</h3>
                <h5>{{ pickup.assigned_partner.name }}</h5>
                <p class="text-muted mb-2">{{ pickup.assigned_partner.organization_type }}</p>
                <p class="mb-1">
                    <i class="fas fa-phone me-2"></i>{{ pickup.assigned_partner.contact_phone }}
                </p>
                <p class="mb-0">
                    <i class="fas fa-clock me-2"></i>{{ pickup.assigned_partner.operating_hours }}
                </p>
            </div>
            {% endif %}

            <!-- Contact Support -->
            <div class="detail-card">
                <h3><i class="fas fa-headset"></i> Need Help?</h3>
                <p class="text-muted">Contact our support team for assistance</p>
                <a href="mailto:support@regenworks.com" class="eco-btn eco-btn-secondary w-100">
                    <i class="fas fa-envelope me-2"></i>Contact Support
                </a>
            </div>

            <!-- Actions -->
            <div class="detail-card">
                <h3><i class="fas fa-cog"></i> Actions</h3>
                <div class="d-grid gap-2">
                    <a href="{{ url_for('pickup_home') }}" class="eco-btn eco-btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to My Pickups
                    </a>
                    {% if pickup.status in ['Requested', 'Assigned'] %}
                    <form method="POST" action="{{ url_for('cancel_pickup', request_id=pickup.request_id) }}">
                        <button type="submit" class="btn btn-danger w-100" onclick="return confirm('Are you sure you want to cancel this pickup?');">
                            <i class="fas fa-times me-2"></i>Cancel Pickup
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>

            <!-- Rating (for completed pickups) -->
            {% if pickup.status == 'Completed' and not pickup.user_rating %}
            <div class="detail-card">
                <h3><i class="fas fa-star"></i> Rate Your Experience</h3>
                <p class="text-muted mb-3">How was your pickup experience?</p>
                <form method="POST" action="{{ url_for('rate_pickup', request_id=pickup.request_id) }}">
                    <div class="mb-3">
                        <label class="form-label">Rating</label>
                        <select class="form-select" name="rating" required>
                            <option value="">Select rating</option>
                            <option value="5">⭐⭐⭐⭐⭐ - Excellent</option>
                            <option value="4">⭐⭐⭐⭐ - Good</option>
                            <option value="3">⭐⭐⭐ - Average</option>
                            <option value="2">⭐⭐ - Poor</option>
                            <option value="1">⭐ - Very Poor</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Feedback (Optional)</label>
                        <textarea class="form-control" name="feedback" rows="2" placeholder="Share your experience..."></textarea>
                    </div>
                    <button type="submit" class="eco-btn eco-btn-primary w-100">
                        <i class="fas fa-paper-plane me-2"></i>Submit Rating
                    </button>
                </form>
            </div>
            {% endif %}

            <!-- Already Rated -->
            {% if pickup.user_rating %}
            <div class="detail-card">
                <h3><i class="fas fa-star"></i> Your Rating</h3>
                <div class="rating-stars mb-2">
                    {% for i in range(pickup.user_rating) %}⭐{% endfor %}
                </div>
                {% if pickup.user_feedback %}
                <p class="text-muted">{{ pickup.user_feedback }}</p>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
